---
authors:
- admin
date: '2019-09-24'
layout: post

title: 'Quantstrat logistic trading model'
subtitle: 'A simple backtested trading strategy in R'
summary: 'I use a simple logistic model to learn a little more about the quantstrat backtesting package in R'

categories: [Quantitative Finance]
projects: [trading]
tags: [quant finance, asset pricing, time series, backtesting]
---

<script src="/rmarkdown-libs/kePrint/kePrint.js"></script>


<p>Over the past few months I have been taking a deeper look into the <code>quantstrat</code> backtesting package in R. At first there is a bit of a learning curve but once I understood the syntax everything became much more intuitive.</p>
<pre class="r"><code>library(quantstrat)
library(PerformanceAnalytics)
library(dplyr)
library(knitr)
library(kableExtra)
library(ggplot2)
library(tibble)
library(tidyquant)</code></pre>
<p>The package expects some initialisation parameters which are used later when compiling the strategy.</p>
<pre class="r"><code>set.seed(1234)

#setting up some initial parameters for the quantstrat trading model
initDate = &quot;2007-01-01&quot;
from &lt;- &quot;2017-01-01&quot;
to &lt;- &quot;2018-12-01&quot;
init_equity &lt;- 1000
adjustment &lt;- TRUE

.orderqty &lt;- 10
.txnfees &lt;- -10

currency(&#39;USD&#39;)</code></pre>
<pre><code>## [1] &quot;USD&quot;</code></pre>
<pre class="r"><code>Sys.setenv(TZ = &quot;UTC&quot;)</code></pre>
<p>I use Yahoo Finance to collect the financial data for Google but we can import data directly from bloomberg terminal as well. I construct a very simplistic logistic strategy which can be switched out easily for a Machine Learning model.</p>
<pre class="r"><code>#Collect the data
symbols &lt;- c(&#39;GOOG&#39;)
.data &lt;- new.env()
getSymbols(symbols, from=from, to=to, src=&quot;yahoo&quot;, adjust=TRUE, env = .data)  </code></pre>
<pre><code>## [1] &quot;GOOG&quot;</code></pre>
<pre class="r"><code>colnames(.data$GOOG) &lt;- c(&quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;, &quot;adjusted&quot;)

mdata &lt;- .data$GOOG</code></pre>
<div id="take-a-look-at-the-data" class="section level4">
<h4>Take a look at the data:</h4>
<table class="table table-striped table-hover table-condensed table-responsive" style="font-size: 12px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-3">Table 1: </span>Stock Data
</caption>
<thead>
<tr>
<th style="text-align:right;">
open
</th>
<th style="text-align:right;">
high
</th>
<th style="text-align:right;">
low
</th>
<th style="text-align:right;">
close
</th>
<th style="text-align:right;">
volume
</th>
<th style="text-align:right;">
adjusted
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
778.81
</td>
<td style="text-align:right;">
789.630
</td>
<td style="text-align:right;">
775.800
</td>
<td style="text-align:right;">
786.14
</td>
<td style="text-align:right;">
1657300
</td>
<td style="text-align:right;">
786.14
</td>
</tr>
<tr>
<td style="text-align:right;">
788.36
</td>
<td style="text-align:right;">
791.340
</td>
<td style="text-align:right;">
783.160
</td>
<td style="text-align:right;">
786.90
</td>
<td style="text-align:right;">
1073000
</td>
<td style="text-align:right;">
786.90
</td>
</tr>
<tr>
<td style="text-align:right;">
786.08
</td>
<td style="text-align:right;">
794.480
</td>
<td style="text-align:right;">
785.020
</td>
<td style="text-align:right;">
794.02
</td>
<td style="text-align:right;">
1335200
</td>
<td style="text-align:right;">
794.02
</td>
</tr>
<tr>
<td style="text-align:right;">
795.26
</td>
<td style="text-align:right;">
807.900
</td>
<td style="text-align:right;">
792.204
</td>
<td style="text-align:right;">
806.15
</td>
<td style="text-align:right;">
1640200
</td>
<td style="text-align:right;">
806.15
</td>
</tr>
<tr>
<td style="text-align:right;">
806.40
</td>
<td style="text-align:right;">
809.966
</td>
<td style="text-align:right;">
802.830
</td>
<td style="text-align:right;">
806.65
</td>
<td style="text-align:right;">
1274600
</td>
<td style="text-align:right;">
806.65
</td>
</tr>
<tr>
<td style="text-align:right;">
807.86
</td>
<td style="text-align:right;">
809.130
</td>
<td style="text-align:right;">
803.510
</td>
<td style="text-align:right;">
804.79
</td>
<td style="text-align:right;">
1176800
</td>
<td style="text-align:right;">
804.79
</td>
</tr>
</tbody>
</table>
<p>I create a naive binary variable which we will try to predict. The model is, if the closing price <code>today</code> is greater or equal to the <code>opening</code> price then the stock has gone up since (or matched) this mornings open price, therefore I assign a <code>1</code> and if the closing price was less than the open then the stock price has gone down since the morning open price, which is assigned <code>0</code>.</p>
<p>Now the problem is not a regression problem but a binary classification problem. I also create two base variables - a <em>Relative Strength Indicator</em> and a <em>Momentum Indicator</em> - feel free to add more technical indicators by looking at the <code>TTR</code> package.</p>
<pre class="r"><code># create the dependent variable for a logistic regression
mdata$direction &lt;- with(mdata, ifelse(close &gt;= open, 1, 0))

#create two basic input variables - lagged
mdata$rsi &lt;- RSI(mdata$close, nFast=14, nSlow = 26, nSig = 9, maType = SMA)
mdata$momentum &lt;- momentum(mdata$close, n = 12)</code></pre>
<p>I lag the dependent variables to <code>t-1</code> since we are trying to predct <code>Y</code> at time <code>t</code> using <code>t-1</code> predictors. I split the data into a <em>naive</em> train and test split - a rolling origin function would be better suited here, see <a href="https://cran.r-project.org/web/ackages/greybox/vignettes/ro.html">rolling origin</a>. Moreover this strategy is just for learning the functionality of the <code>quantstrat</code> package in R.</p>
<pre class="r"><code>mdata &lt;- mdata[complete.cases(mdata), ] 
mdata$direction_fwd &lt;- lag.xts(mdata$direction, k = -1)
# create a training and test set
train_date &lt;- nrow(mdata) *0.8
train &lt;- mdata[1:train_date,]
test &lt;- mdata[-c(1:train_date),]</code></pre>
<p>Using the Generalise Linear Model in R we can fit a model on the training data, <code>family = binomial</code> since we have a <code>0</code> or <code>1</code> binary classification problem now.</p>
<pre class="r"><code>#Run a simple logistic regression and obtain predicted probabilities
lm.fit &lt;- glm(direction_fwd ~ rsi + momentum, data = train, family = binomial)</code></pre>
</div>
<div id="summary-statistics" class="section level4">
<h4>Summary Statistics</h4>
<pre class="r"><code>summary(lm.fit)</code></pre>
<pre><code>## 
## Call:
## glm(formula = direction_fwd ~ rsi + momentum, family = binomial, 
##     data = train)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.6726  -1.2559   0.9724   1.0865   1.3351  
## 
## Coefficients:
##              Estimate Std. Error z value Pr(&gt;|z|)  
## (Intercept) -0.415182   0.583453  -0.712   0.4767  
## rsi          0.012826   0.010511   1.220   0.2224  
## momentum    -0.008590   0.004133  -2.078   0.0377 *
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 514.92  on 374  degrees of freedom
## Residual deviance: 509.71  on 372  degrees of freedom
## AIC: 515.71
## 
## Number of Fisher Scoring iterations: 4</code></pre>
</div>
<div id="make-the-predictions-on-the-held-out-test-set" class="section level4">
<h4>Make the predictions on the held out test set:</h4>
<pre class="r"><code>pr.lm &lt;- predict(lm.fit, test, type = &quot;response&quot;)
test$pred_prob &lt;- pr.lm

pr.lm %&gt;%
  data.frame() %&gt;%
  rownames_to_column(&quot;dates&quot;) %&gt;%
  rename(preds = &quot;.&quot;) %&gt;%
  ggplot(aes(x = preds)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(preds)), color = &quot;blue&quot;, linetype = &quot;dashed&quot;, size = 1) +
  theme_tq() +
  ggtitle(&quot;Probability predctions on the test set&quot;) +
  xlab(&quot;Density&quot;) +
  ylab(&quot;Predicted Probabilities&quot;)</code></pre>
<p><img src="/post/logistic-trading-strategy/logistic-trading-strategy_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>Not great but we do only have two predictors. From here we can create a cut-off score and say that all probabilities greater than <code>0.6</code> we assign a 1, else if they are less than or equal to <code>0.6</code> we assign a <code>0</code>. We can see how accurate the model is:</p>
<pre class="r"><code>#Add our predictions to the TEST data if its greater than 0.6
test$prediction &lt;- ifelse(pr.lm &gt; 0.6, 1, 0)

paste0(&quot;Accuracy: &quot;, mean(test$direction_fwd == test$prediction, na.rm = T))</code></pre>
<pre><code>## [1] &quot;Accuracy: 0.602150537634409&quot;</code></pre>
</div>
<div id="applying-the-model-to-a-strategy" class="section level4">
<h4>Applying the model to a strategy</h4>
<p>check:<a href="https://stackoverflow.com/questions/53713017/very-simple-quantstrat-trading-model-using-logistic-regression" class="uri">https://stackoverflow.com/questions/53713017/very-simple-quantstrat-trading-model-using-logistic-regression</a></p>
<pre class="r"><code># Simple way to run applyStrategy is to make sure the data for the symbol is in a variable with its name, like so:
GOOG &lt;- test


stock(&quot;GOOG&quot;, currency=&quot;USD&quot;, multiplier=1)</code></pre>
<pre><code>## [1] &quot;GOOG&quot;</code></pre>
<pre class="r"><code>strategy.st &lt;- portfolio.st &lt;- account.st &lt;- &quot;LogisticRegressionStrategy&quot;
rm.strat(strategy.st)
rm.strat(portfolio.st)
rm.strat(account.st)



initPortf(name = portfolio.st,
          symbols = symbols, 
          initDate = initDate, 
          currency = &#39;USD&#39;)</code></pre>
<pre><code>## [1] &quot;LogisticRegressionStrategy&quot;</code></pre>
<pre class="r"><code>initAcct(name = account.st, 
         portfolios = portfolio.st, 
         initDate = initDate, 
         currency = &#39;USD&#39;,
         initEq = init_equity)</code></pre>
<pre><code>## [1] &quot;LogisticRegressionStrategy&quot;</code></pre>
<pre class="r"><code>initOrders(portfolio.st,
           symbols = symbols,
           initDate = initDate)

strategy(strategy.st, store = TRUE)

nMult_orderqty &lt;- 2
addPosLimit(portfolio.st, symbol = &quot;GOOG&quot;, timestamp = initDate, maxpos = nMult_orderqty * .orderqty)

# Buy when prob exceeds 0.6 for the first time, using cross= TRUE
add.signal(strategy = strategy.st,
         name = &quot;sigThreshold&quot;,
         arguments = list(threshold=0.6, column=&quot;pred_prob&quot;, relationship=&quot;gt&quot;, cross= TRUE),
         label = &quot;longSig&quot;)</code></pre>
<pre><code>## [1] &quot;LogisticRegressionStrategy&quot;</code></pre>
<pre class="r"><code> #exit when prob drops below 0.5 for the first time
add.signal(strategy = strategy.st,
           name = &quot;sigThreshold&quot;,
           arguments = list(threshold=0.5, column=&quot;pred_prob&quot;, relationship=&quot;lt&quot;, cross= TRUE),
           label = &quot;exitLongSig&quot;)</code></pre>
<pre><code>## [1] &quot;LogisticRegressionStrategy&quot;</code></pre>
<pre class="r"><code># Adding the rules, enter at the low price when &quot;prediction&quot; = 1, taking transaction fees into account
add.rule(strategy = strategy.st,
         name = &quot;ruleSignal&quot;,
         arguments = list(sigcol = &quot;longSig&quot;,
                          sigval = 1,
                          orderqty = .orderqty,
                          ordertype = &quot;market&quot;,
                          orderside = &quot;long&quot;,
                          osFUN = osMaxPos,
                          prefer = &quot;Open&quot;,  #Never kknow the low in advance. Use the open, as it is for the next day (be aware that the open price for bar data has its own problems too)
                          TxnFees = .txnfees, 
                          replace = FALSE),
         type = &quot;enter&quot;,
         label = &quot;EnterLONG&quot;)</code></pre>
<pre><code>## [1] &quot;LogisticRegressionStrategy&quot;</code></pre>
<pre class="r"><code># As soon as the Logistic regression predicts a &quot;0&quot; we dump all our shares in GOOG

add.rule(strategy.st, 
         name = &quot;ruleSignal&quot;, 
         arguments = list(sigcol = &quot;exitLongSig&quot;, 
                          sigval = 1, 
                          ordertype = &quot;market&quot;, 
                          orderside = &quot;long&quot;,
                          orderqty = &quot;all&quot;, 
                          TxnFees = .txnfees, 
                          replace = TRUE), 
         type = &quot;exit&quot;, 
         label = &quot;Exit2SHORT&quot;)</code></pre>
<pre><code>## [1] &quot;LogisticRegressionStrategy&quot;</code></pre>
<pre class="r"><code>applyStrategy(strategy.st, portfolios = portfolio.st)</code></pre>
<pre><code>## [1] &quot;2018-08-10 00:00:00 GOOG 10 @ 1243&quot;
## [1] &quot;2018-08-24 00:00:00 GOOG 10 @ 1208.819946&quot;
## [1] &quot;2018-10-04 00:00:00 GOOG -20 @ 1168.189941&quot;
## [1] &quot;2018-10-09 00:00:00 GOOG 10 @ 1146.150024&quot;
## [1] &quot;2018-10-11 00:00:00 GOOG 10 @ 1072.939941&quot;
## [1] &quot;2018-11-15 00:00:00 GOOG -20 @ 1064.709961&quot;
## [1] &quot;2018-11-19 00:00:00 GOOG 10 @ 1057.199951&quot;
## [1] &quot;2018-11-26 00:00:00 GOOG 10 @ 1038.349976&quot;
## [1] &quot;2018-11-30 00:00:00 GOOG -20 @ 1094.430054&quot;</code></pre>
<pre class="r"><code>updatePortf(portfolio.st)</code></pre>
<pre><code>## [1] &quot;LogisticRegressionStrategy&quot;</code></pre>
<pre class="r"><code>updateAcct(account.st)</code></pre>
<pre><code>## [1] &quot;LogisticRegressionStrategy&quot;</code></pre>
<pre class="r"><code>updateEndEq(account.st)</code></pre>
<pre><code>## [1] &quot;LogisticRegressionStrategy&quot;</code></pre>
<pre class="r"><code>chart.Posn(portfolio.st, Symbol = &quot;GOOG&quot;, 
           TA=&quot;add_SMA(n = 10, col = 2); add_SMA(n = 30, col = 4)&quot;)</code></pre>
<p><img src="/post/logistic-trading-strategy/logistic-trading-strategy_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
